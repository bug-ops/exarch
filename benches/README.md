# Exarch Benchmark Suite

Comprehensive performance benchmarks for the exarch archive extraction library.

## Performance Targets

| Operation | Target | Notes |
|-----------|--------|-------|
| TAR extraction | 500 MB/s | Throughput on uncompressed TAR |
| ZIP extraction | 300 MB/s | Throughput on stored ZIP |
| Path validation | < 1 us | Per entry validation |
| Symlink validation | < 5 us | Per symlink entry |
| Format detection | < 10 us | Per file |

## Quick Start

```bash
# 1. Generate benchmark fixtures (required first time)
./benches/fixtures/generate_fixtures.sh

# 2. Run all benchmarks
./benches/run_all.sh

# 3. View HTML report
open target/criterion/report/index.html
```

## Benchmark Types

### Rust Criterion Benchmarks

Located in `crates/exarch-core/benches/`:

- **extraction.rs** - Archive extraction throughput
  - TAR (uncompressed, gzip, bzip2, xz, zstd)
  - ZIP (stored, deflate)
  - 7z
  - Different sizes (1MB, 10MB, 100MB)
  - Different structures (many files, nested dirs)

- **creation.rs** - Archive creation throughput
  - TAR and ZIP creation
  - Compression level comparison
  - File count scaling

- **validation.rs** - Security validation performance
  - Path validation (< 1 us target)
  - Symlink validation
  - Hardlink validation
  - Compression ratio checks (zip bomb detection)
  - Entry validator orchestration

- **progress.rs** - Progress callback overhead measurement

### Comparison Benchmarks

- **compare_python.py** - exarch vs native Python tarfile/zipfile
- **compare_node.js** - exarch-rs vs tar-fs/adm-zip

## Running Benchmarks

### Full Benchmark Suite

```bash
./benches/run_all.sh
```

### Quick Benchmarks (fewer iterations)

```bash
./benches/run_all.sh --quick
```

### Rust Only

```bash
./benches/run_all.sh --rust-only
```

### Comparison Only

```bash
./benches/run_all.sh --compare
```

### Individual Benchmark

```bash
# Run from project root
cd crates/exarch-core

# Run specific benchmark file
cargo bench --bench extraction

# Run specific benchmark group
cargo bench --bench validation -- path_validation

# Run with baseline comparison
cargo bench -- --save-baseline main
cargo bench -- --baseline main
```

## Benchmark Fixtures

Generated by `./fixtures/generate_fixtures.sh`:

| Fixture | Description | Size |
|---------|-------------|------|
| small_files.* | 1000 files x 1KB | ~1 MB |
| medium_files.* | 100 files x 100KB | ~10 MB |
| large_file.* | 1 file x 100MB | 100 MB |
| compressible_large.* | Highly compressible 100MB | ~100 MB |
| nested_dirs.* | 20 levels deep, 3 files/level | ~60 KB |
| many_files.* | 10,000 tiny files | ~200 KB |
| mixed.* | Mixed file sizes | ~10.5 MB |

Formats generated: `.tar`, `.tar.gz`, `.tar.bz2`, `.tar.xz`, `.tar.zst`, `.zip`, `.7z`

### Regenerating Fixtures

```bash
rm -rf benches/fixtures/*.tar* benches/fixtures/*.zip benches/fixtures/*.7z
./benches/fixtures/generate_fixtures.sh
```

## Interpreting Results

### Criterion Reports

Criterion generates detailed HTML reports in `target/criterion/`:

- **Throughput** - MB/s or ops/s
- **Mean/Median** - Average execution time
- **Std Dev** - Variability
- **Outliers** - Unusual measurements
- **Change** - Regression/improvement vs baseline

### Performance Targets

Check the benchmark output against targets:

```
path_validation/simple:
  time: 800 ns (target: < 1000 ns) [PASS]

tar_extraction/large_100mb:
  throughput: 520 MB/s (target: 500 MB/s) [PASS]
```

### Regression Detection

```bash
# Save baseline
cargo bench -- --save-baseline before-change

# Make changes, then compare
cargo bench -- --baseline before-change

# Look for "Performance has regressed" warnings
```

## CI Integration

Add to CI workflow:

```yaml
- name: Run benchmarks
  run: |
    ./benches/fixtures/generate_fixtures.sh
    cargo bench -- --noplot

- name: Check for regressions
  run: |
    # Fail if any benchmark regressed by >10%
    cargo bench -- --baseline main | grep -q "regressed" && exit 1 || exit 0
```

## Adding New Benchmarks

1. Add benchmark function in appropriate file:

```rust
fn benchmark_new_feature(c: &mut Criterion) {
    let mut group = c.benchmark_group("new_feature");
    group.throughput(Throughput::Bytes(size));

    group.bench_function("variant_a", |b| {
        b.iter(|| {
            // Code to benchmark
        });
    });

    group.finish();
}
```

2. Add to criterion_group:

```rust
criterion_group!(
    benches,
    // ... existing benchmarks
    benchmark_new_feature,
);
```

3. If new fixture needed, update `fixtures/generate_fixtures.sh`

## Troubleshooting

### Fixtures not found

```bash
./benches/fixtures/generate_fixtures.sh
```

### Python benchmarks skipped

```bash
cd crates/exarch-python
maturin develop --release
```

### Node.js benchmarks skipped

```bash
cd crates/exarch-node
npm run build
npm install tar adm-zip  # For comparison
```

### High variance in results

- Close other applications
- Run multiple times
- Use `--warm-up-time 5` for longer warmup
- Consider `--measurement-time 10` for more samples

### Criterion version mismatch

Ensure workspace uses consistent criterion version:

```toml
# Cargo.toml
[workspace.dependencies]
criterion = "0.5"
```

## Files

```
benches/
├── README.md                  # This file
├── run_all.sh                # Main benchmark runner
├── compare_python.py         # Python comparison script
├── compare_node.js           # Node.js comparison script
├── fixtures/
│   ├── generate_fixtures.sh  # Fixture generator
│   └── *.tar, *.zip, *.7z    # Generated test archives
└── BENCHMARK_RESULTS.md      # Generated results (after run)

crates/exarch-core/benches/
├── extraction.rs             # Extraction benchmarks
├── creation.rs               # Creation benchmarks
├── validation.rs             # Validation benchmarks
└── progress.rs               # Progress callback benchmarks
```

## Benchmark Results (v0.2.1)

### Python Comparison (exarch vs tarfile/zipfile)

| Archive | exarch (ms) | Native (ms) | Speedup | Throughput |
|---------|-------------|-------------|---------|------------|
| TAR small (1MB, 1000 files) | 122.1 | 156.8 | **1.28x** | 8 MB/s |
| TAR+GZIP small | 124.6 | 171.2 | **1.37x** | 8 MB/s |
| TAR medium (10MB) | 16.7 | 19.2 | **1.15x** | 586 MB/s |
| TAR large (100MB) | 21.4 | 28.9 | **1.35x** | 4,671 MB/s |
| ZIP small (1MB) | 126.5 | 109.0 | 0.86x | 8 MB/s |
| ZIP medium (10MB) | 18.6 | 14.0 | 0.75x | 524 MB/s |
| ZIP large (100MB) | 41.0 | 34.1 | 0.83x | 2,439 MB/s |

**Average speedup: 1.08x** faster than Python tarfile/zipfile

### Node.js Comparison (exarch-rs vs tar/adm-zip)

| Archive | exarch (ms) | Native (ms) | Speedup | Throughput |
|---------|-------------|-------------|---------|------------|
| TAR small (1MB, 1000 files) | 119.1 | 92.1 | 0.77x | 8 MB/s |
| TAR+GZIP medium | 18.6 | 28.2 | **1.52x** | 525 MB/s |
| TAR+GZIP large (100MB) | 40.6 | 121.7 | **3.00x** | 2,466 MB/s |
| ZIP small (1MB) | 126.4 | 126.8 | **1.00x** | 8 MB/s |
| ZIP medium (10MB) | 17.7 | 47.3 | **2.67x** | 552 MB/s |
| ZIP large (100MB) | 42.8 | 269.3 | **6.29x** | 2,336 MB/s |

**Average speedup: 1.94x** faster than Node.js tar/adm-zip

### Performance vs Targets

| Metric | Target | Achieved | Status |
|--------|--------|----------|--------|
| TAR extraction | 500 MB/s | 2,000+ MB/s | ✅ **4x target** |
| ZIP extraction | 300 MB/s | 1,400+ MB/s | ✅ **4.7x target** |
| Path validation | < 1 µs | ~85 ns | ✅ **12x better** |

> [!NOTE]
> Results measured on Apple M1 Pro. Performance varies by hardware.

## Related Documentation

- [Criterion User Guide](https://bheisler.github.io/criterion.rs/book/)
- [CLAUDE.md Performance Section](../CLAUDE.md#4-performance)
- [cargo-flamegraph](https://github.com/flamegraph-rs/flamegraph)
